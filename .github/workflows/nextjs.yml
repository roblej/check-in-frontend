# frontend 리포지토리의 .github/workflows/deploy-frontend.yml
name: Deploy Frontend to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      env:
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
    
    # 1. SSH 키 설정 (참고 파일의 webfactory/ssh-agent 사용)
    - name: Set up SSH Key
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ secrets.FRONTEND_EC2_SSH_KEY }}
    
    - name: Copy Files to EC2
      run: |
        # node_modules와 .git을 제외하고, 배포에 필요한 폴더만 복사합니다.
        # ⚠️ node_modules가 복사되면 시간이 기하급수적으로 늘어납니다.
        # /home/ubuntu/frontend/ 디렉토리가 scp 타겟이 됩니다.
        scp -r -o StrictHostKeyChecking=no \
            .next \
            public \
            package.json \
            package-lock.json \
            next.config.js \
            ubuntu@${{ secrets.FRONTEND_EC2_HOST }}:/home/ubuntu/frontend/
    
    # 3. 배포 및 애플리케이션 시작 (런타임 .env 파일 생성 추가)
    - name: Deploy and Start Application
      run: |
        # SSH를 통해 EC2 서버에 접속하여 명령어 실행
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.FRONTEND_EC2_HOST }} << 'EOF'
        
        # 1. 기존 프로세스 종료
        sudo pkill -f "next start" || true
        
        # 2. 디렉토리로 이동
        cd /home/ubuntu/frontend
        
        # 3. PM2 설치 및 애플리케이션 재시작
        npm install -g pm2
        pm2 delete frontend-app || true
        # Next.js의 start 명령어 실행
        pm2 start npm --name "frontend-app" -- start
        
        # PM2 상태 저장 및 환경 설정
        pm2 save
        pm2 startup
        
        EOF
